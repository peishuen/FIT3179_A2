{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 800,
  "height": 400,

  "data": {
    "url": "https://raw.githubusercontent.com/peishuen/FIT3179_A2/main/idioms/dumbbell_plot/gdp_state_real_supply.csv",
    "format": {"type": "csv"}
  },

  "title": {
    "text": "State GDP Growth Before and After COVID-19 (2019 vs 2023)"
  },

  "transform": [
    {"filter": "datum.series == 'growth_yoy'"},
    {"filter": "datum.sector == 'p0'"},
    {"filter": "datum.state != 'Supra'"},
    {"filter": "year(datum.date) == 2019 || year(datum.date) == 2023"},
    {"calculate": "year(datum.date)", "as": "year"},
    {
      "pivot": "year",
      "value": "value",
      "groupby": ["state"]
    },
    {"calculate": "datum['2023'] - datum['2019']", "as": "change"},
    {"calculate": "datum.change >= 0 ? 'Growth' : 'Decline'", "as": "direction"},
    {"calculate": "format(datum['2019'], '.1f') + '%'", "as": "growth_2019_label"},
    {"calculate": "format(datum['2023'], '.1f') + '%'", "as": "growth_2023_label"},
    {"calculate": "format(datum.change, '.1f') + '%'", "as": "change_label"}
  ],

  "layer": [
    {
      "params": [
        {
          "name": "highlight",
          "select": {
            "type": "point",
            "fields": ["state"],
            "on": "click",
            "clear": "dblclick"
          }
        }
      ],
      "mark": {"type": "rule", "strokeWidth": 2, "opacity": 0.5, "color": "#888888"},
      "encoding": {
        "y": {"field": "state", "type": "nominal", "sort": "-x", "title": "State"},
        "x": {"field": "2019", "type": "quantitative", "title": "GDP Growth Rate (%)"},
        "x2": {"field": "2023"},
        "opacity": {
            "condition": {"param": "highlight", "value": 1},
            "value": 0.2
        },
        "tooltip": [{"field": "change_label", "title": "Change (2019 â†’ 2023)"}]
      }
    },
    {
      "mark": {"type": "circle", "size": 90, "color": "#926EFF", "opacity": 1},
      "encoding": {
        "y": {"field": "state", "type": "nominal"},
        "x": {"field": "2019", "type": "quantitative"},
        "opacity": {
            "condition": {"param": "highlight", "value": 1},
            "value": 0.2
        },
        "tooltip": [
          {"field": "state", "title": "State"},
          {"field": "growth_2019_label", "title": "2019 Growth"}
        ]
      }
    },
    {
      "mark": {"type": "circle", "size": 90, "color": "#D69AD6", "opacity": 1},
      "encoding": {
        "y": {"field": "state", "type": "nominal"},
        "x": {"field": "2023", "type": "quantitative"},
        "opacity": {
            "condition": {"param": "highlight", "value": 1},
            "value": 0.2
        },
        "tooltip": [
          {"field": "state", "title": "State"},
          {"field": "growth_2023_label", "title": "2023 Growth"}
        ]
      }
    },
    { 
      "data": {
        "values": [{"state": "Negeri Sembilan"}]
      },
      "mark": {"type": "rect", "color": "#fff8e1","stroke": "#c08d01"},
      "encoding": {
        "x": {"datum": 5.4}, 
        "x2": {"datum": 6.8},
        "y": {"value": 105},
        "y2": {"value": 164},
        "opacity": {
          "condition": {
          "test": "!length(data('highlight_store')) || datum['state'] == highlight['state']",
          "value": 1
          },
          "value": 0
        }
      }
    },
    {
      "data": {
        "values": [{"state": "Negeri Sembilan"}]
      },
      "mark": {"type": "text", "align": "center", "dx": 11},
      "encoding": {
        "x": {"datum": 6.0},
        "y": {"value": 120},
        "text": {
          "value": ["Weaker industrial output", "and trade exposure", "slowed recovery."]
        },
        "opacity": {
          "condition": {
          "test": "!length(data('highlight_store')) || datum['state'] == highlight['state']",
          "value": 1
          },
          "value": 0
        }
      }
    },
    {
      "data": {
        "values": [{"state": "Negeri Sembilan"}]
      },
      "mark": {"type": "rule", "color": "#c08d01", "strokeWidth": 1.1},
      "encoding": {
          "x": {"datum": 5.12},
          "x2": {"datum": 5.4},
          "y": {"value": 120},
          "y2": {"value": 135},
          "opacity": {
            "condition": {
            "test": "!length(data('highlight_store')) || datum['state'] == highlight['state']",
            "value": 1
            },
            "value": 0
        }
      }
    },
    { 
      "data": {
        "values": [{"state": "Johor"}]
      },
      "mark": {"type": "rect", "color": "#fff8e1","stroke": "#c08d01"},
      "encoding": {
        "x": {"datum": 4.7}, 
        "x2": {"datum": 6.95},
        "y": {"value": 10},
        "y2": {"value": 55},
        "opacity": {
            "condition": {
            "test": "!length(data('highlight_store')) || datum['state'] == highlight['state']",
            "value": 1
            },
            "value": 0
        }
      }
    },
    { 
      "data": {
        "values": [{"state": "Johor"}]
      },
      "mark": {"type": "text", "align": "center", "dx": 28},
      "encoding": {
        "x": {"datum": 5.58},
        "y": {"value": 25},
        "text": {
          "value": ["Construction and cross-border projects", "lifted growth above pre-pandemic levels."]
        },
        "opacity": {
            "condition": {
            "test": "!length(data('highlight_store')) || datum['state'] == highlight['state']",
            "value": 1
            },
            "value": 0
        }
      }
    },
    {
      "data": {
        "values": [{"state": "Johor"}]
      },
      "mark": {"type": "rule", "color": "#c08d01", "strokeWidth": 1.1},
      "encoding": {
          "x": {"datum": 4.1},
          "x2": {"datum": 4.7},
          "y": {"value": 13},
          "y2": {"value": 34},
          "opacity": {
            "condition": {
            "test": "!length(data('highlight_store')) || datum['state'] == highlight['state']",
            "value": 1
            },
            "value": 0
        }
      }
    },

    {
      "data": {
        "values": [
          {"year": "2019", "color": "#926EFF"},
          {"year": "2023", "color": "#D69AD6"}
        ]
      },
      "mark": {
        "type": "point",
        "shape": "circle",
        "filled": true
      },
      "encoding": {
        "x": {"value": 0}, 
        "y": {"value": 0},
        "color": {
          "field": "year",
          "type": "nominal",
          "scale": {"domain": ["2019", "2023"], "range": ["#926EFF", "#D69AD6"]},
          "legend": {
            "title": "Year",
            "titleFontSize": 14,
            "labelFontSize": 13,
            "symbolSize": 150,
            "symbolType": "circle",
            "titleColor": "#858585",
            "labelColor": "#858585"
          }
        },
        "opacity": {"value": 0}
      }
    }
  ],

  "config": {
    "title": {
      "fontSize": 25, 
      "fontWeight": "bold", 
      "anchor": "middle", 
      "offset": 20,
      "color": "#5c5c5c"
    },
    "axis": {
      "titleFontSize": 15, 
      "titlePadding": 18, 
      "titleFontWeight": 600, 
      "titleColor": "#858585",
      "labelFontSize": 13, 
      "labelFontWeight": 200,
      "labelColor": "#858585"
    },
    "text": {
      "fontWeight": "lighter",
      "fontSize": 14,
      "color": "#858585"
    }
  }  
}